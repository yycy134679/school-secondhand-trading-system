**版本**: 1.0
**日期**: 2025-10-23

## 一、概述

### 1.1 产品描述

本项目旨在开发一个面向校园用户的二手交易推荐系统。系统允许学生用户作为买家和卖家双重身份，自由发布、浏览、搜索二手商品并联系卖家，线下完成交易。产品的核心亮点在于，系统能够根据用户的最近浏览历史，通过商品标签匹配，为用户提供个性化的商品推荐，从而提升商品发现效率和用户体验。

系统将包含一个功能完备的前台应用和一个用于内容审核与数据管理的后台系统。

【核心业务规则：一物一件】本平台所有商品均为“一物一件”模式，即每条商品记录的可售库存永远为1，不支持同一记录下的多库存。本平台不提供在线下单/支付功能，交易在线下完成。

### 1.2 角色与权限

1.  **学生用户 (Student User)**: 系统的核心参与者,同时具备买家和卖家两种身份。
    *   **权限**: 注册、登录、管理个人信息、发布/管理商品、浏览/搜索商品。
2.  **管理员 (Administrator)**: 系统的维护者和监督者。
    *   **权限**: 访问后台管理系统、维护商品分类和标签库。
3.  **访客 (Visitor)**: 未登录的用户。
    *   **权限**: 浏览商品首页、分类页、搜索结果页和商品详情页,但无法进行任何需要身份认证的操作。

### 1.3 商品状态机定义

为保证系统的数据一致性和业务逻辑的严谨性,本系统对商品状态进行统一管理。商品在其生命周期内只能处于以下三种状态之一,状态间的流转必须遵循严格的规则（线下交易，不涉及下单/支付）。

#### 1.3.1 状态定义

1.  **在售 (For Sale)**
    *   **含义**: 商品处于可交易状态,公开展示在平台上,任何用户都可以浏览并联系卖家。
    *   **特征**: 这是商品发布后的默认状态,也是卖家主动上架后的状态。

2.  **已售 (Sold)**
    *   **含义**: 线下交易已完成,卖家将商品标记为已售。
    *   **特征**: 
        *   这是商品的终态之一,一旦进入该状态,不可逆转。
        *   处于该状态的商品不再公开展示,不可编辑,不可重新上架。
        *   该状态与"已下架"状态互斥,商品不可能同时处于两种状态。

3.  **已下架 (Delisted)**
    *   **含义**: 卖家主动将商品下架,暂时不对外展示和销售,但数据保留在系统中。
    *   **特征**: 
        *   不公开展示在任何商品列表页或搜索结果中。
        *   可以被卖家重新编辑和上架。
        *   该状态与"已售"状态互斥。

#### 1.3.2 状态流转规则

商品状态的流转必须遵循以下规则,任何违反规则的操作都应被系统拒绝:

```
[在售] ---(卖家下架)---> [已下架]
[在售] ---(线下成交/卖家标记已售)---> [已售] (终态)
[已下架] ---(卖家重新上架)---> [在售]
[已下架] ---(卖家编辑)---> [已下架] (状态不变)
```

**重要约束**:
*   **已售** 状态是终态,一旦进入不可流转到其他任何状态。
*   **已售** 与 **已下架** 互斥,商品不可能同时或先后处于这两种状态。
*   只有 **在售** 和 **已下架** 状态的商品可以被卖家编辑。
*   **已售** 商品不可编辑、不可下架、不可重新上架。
*   补充明确：**已售**为全局终态，禁止任何形式的状态变更（包括“重新上架”）；若需再次售卖，必须创建一条新的商品。

#### 1.3.3 状态的权限与可见性

| 状态 | 买家可见 | 卖家可编辑 | 卖家可下架 | 卖家可上架 |
|------|----------|------------|------------|------------|
| 在售 | ✓ | ✓ | ✓ | - |
| 已售 | ✗ | ✗ | ✗ | ✗ |
| 已下架 | ✗ | ✓ | - | ✓ |

说明：
- 本表中的“买家可见”指“公开列表/聚合页”的可见性，不包含“持链接访问详情页”的规则；详情页的访问与展示规则见2.10（任意状态均可访问，非在售状态展示状态横幅）。

## 二、功能需求

### 2.1. 用户注册 (Function Point 1)

1.  **用户故事**: 作为一个新访客，我希望能通过提供一个唯一的登录账号、昵称和密码来创建一个新账户，以便使用平台的全部功能。
2.  **前置条件**: 用户必须处于未登录状态。
3.  **后置条件**: 成功创建新用户，系统自动为用户执行登录操作，并直接跳转到商品首页。
4.  **界面及交互**:
    *   **注册表单**:
        *   **登录账号输入框**: 提示文字"请输入登录账号（英文+数字组合）"。
    *   **昵称输入框**: 提示文字"请输入您的昵称"。
        *   **密码输入框**: 提示文字"请输入密码（至少8位）"，输入内容显示为密文。
        *   **确认密码输入框**: 提示文字"请再次输入密码"，输入内容显示为密文。
        *   **注册按钮**: 点击后触发表单提交。
    *   **昵称说明**: 昵称仅用于展示，不唯一（可重复）；登录账号必须全局唯一。
5.  **业务流程**:
    1.  用户进入注册页面，填写表单信息。
    2.  用户点击"注册"按钮。
    3.  前端对表单进行基本校验（如非空、两次密码一致）。
    4.  前端将校验通过的数据发送至后端。
    5.  后端进行基本的数据格式和唯一性校验。
    6.  后端将新用户信息存入数据库（密码明文存储）。
    7.  后端生成简单的会话标识并返回注册成功响应。
    8.  前端存储会话信息，显示"注册成功，已为您自动登录"提示，并自动跳转到商品首页。
6.  **异常/分支流程**:
    *   **登录账号已存在**: 提示"该账号已被注册，请更换一个"。
    *   **登录账号格式错误**: 提示"账号只能由英文字母和数字组成"。
    *   **密码不符合强度要求**: 提示"密码长度不能少于8位"。
    *   **两次密码不一致**: 提示"两次输入的密码不一致"。
    *   **任一字段为空**: 提示"请填写所有必填项"。

*   [ ] **验收标准1**: 用户可以使用未被占用的、符合格式的登录账号成功注册。
*   [ ] **验收标准2**: 系统对所有输入进行基本的后端校验，并能正确处理各种异常情况并给出友好提示。
*   [ ] **验收标准3**: 注册成功后，系统自动为用户创建登录会话，并跳转到商品首页，同时显示"注册成功，已为您自动登录"的提示信息。

### 2.2. 用户登录 (Function Point 2)

1.  **用户故事**: 作为一个已注册用户，我希望能使用我的登录账号和密码登录系统，以便访问我的个人信息和平台功能。
2.  **前置条件**: 用户必须拥有一个已注册的账户，且当前处于未登录状态。
3.  **后置条件**: 成功登录后，用户被授权访问系统，并跳转到商品首页。
4.  **界面及交互**:
    *   **登录表单**:
        *   **登录账号输入框**: 提示文字“请输入登录账号”。
        *   **密码输入框**: 提示文字“请输入密码”，输入内容显示为密文。
        *   **“记住我”复选框**: 允许用户选择保持登录状态。
        *   **登录按钮**: 点击后触发表单提交。
5.  **业务流程**:
    1.  用户进入登录页面，填写账号和密码。
    2.  用户点击"登录"按钮。
    3.  前端将数据发送至后端。
    4.  后端验证账号是否存在，并验证密码是否匹配。
    5.  验证通过，生成简单的会话标识返回给前端。
    6.  前端存储会话信息，并更新UI为登录状态，跳转到首页。
6.  **异常/分支流程**:
    *   **账号或密码错误**: 提示"登录账号或密码不正确"。

*   [ ] **验收标准1**: 用户可以使用正确的账号和密码成功登录系统。
*   [ ] **验收标准2**: 系统提供友好的错误提示。
*   [ ] **验收标准3**: "记住我"功能勾选后，用户在7天内可以免登录。

### 2.3. 用户个人信息管理 (Function Point 3)

1.  **用户故事**: 作为一个登录用户，我希望能查看和修改我的头像、昵称和密码，以管理我的个人形象和账户安全。
2.  **前置条件**: 用户必须处于登录状态。
3.  **后置条件**: 用户的个人信息在数据库中被更新，并在全站生效。
4.  **界面及交互**:
    *   **个人中心页面**:
        *   **头像区域**: 显示当前头像，点击或悬浮后出现“更换头像”按钮，触发文件上传。
    *   **昵称区域**: 显示当前昵称，旁边有“修改”按钮。点击后变为输入框和“保存”按钮。
        *   **修改密码区域**: 包含“当前密码”、“新密码”、“确认新密码”三个输入框和“确认修改”按钮。
5.  **业务流程**:
    *   **修改头像**: 用户上传新图片 -> 后端校验格式和大小 -> 保存图片 -> 更新用户头像URL。
    *   **修改昵称**: 用户输入新昵称 -> 后端校验（如频率限制） -> 更新昵称。
    *   **昵称唯一性说明**: 昵称仅用于展示，不唯一（可重复）；修改昵称不进行唯一性校验。
    *   **修改密码**: 用户输入旧密码和新密码 -> 后端验证旧密码正确性 -> 验证新密码强度 -> 更新哈希后的密码。
6.  **异常/分支流程**:
    *   **上传图片格式/大小不符**: 提示“请上传JPG/PNG格式且小于2MB的图片”。
    *   **修改昵称过于频繁**: 提示“昵称在30天内只能修改一次”。
    *   **旧密码错误**: 提示“当前密码不正确”。

*   [ ] **验收标准1**: 用户可以成功上传新头像，新头像在全站生效。
*   [ ] **验收标准2**: 用户可以成功修改昵称，但30天内只能修改一次。
*   [ ] **验收标准3**: 用户必须通过验证旧密码才能成功设置新密码。
*   [ ] **验收标准4**: 修改密码成功后，用户当前的登录状态保持有效。

### 2.4. 发布新商品 (Function Point 4)

1.  **用户故事**: 作为一个卖家，我希望能填写商品的详细信息（如标题、描述、价格、图片、分类和标签），并将其发布到平台上供他人购买。
2.  **前置条件**: 用户必须处于登录状态。
3.  **后置条件**: 成功创建一条新的商品记录，状态为“在售”，并显示在“我发布的商品”列表中。
4.  **界面及交互**:
    *   **发布商品表单**:
        *   **商品标题**: 文本输入框。
        *   **商品描述**: 多行文本输入框。
        *   **商品价格**: 数字输入框。
        *   **商品图片**: 图片上传控件，支持多图上传预览。
        *   **商品标签**: 从预设标签列表中进行多选。
        *   **商品分类**: 从预设分类下拉菜单中进行单选。
        *   **新旧程度**: 从预设选项中进行单选。
        *   **发布按钮**: 点击后提交表单。
5.  **业务流程**:
    1.  用户进入发布商品页面，填写所有必填信息。
    2.  用户点击“发布”按钮。
    3.  后端对所有字段进行严格校验。
    4.  后端处理并存储图片。
    5.  后端将新的商品信息存入数据库，状态为“在售”。
    6.  返回成功响应，引导用户至商品详情页或“我发布的商品”列表。
6.  **异常/分支流程**:
    *   **必填项为空**: 提示用户填写所有必填项。
    *   **数据格式错误**: 如价格非数字，提示格式错误。
    *   **图片数量/大小/格式超限**: 给出相应提示。

*   [ ] **验收标准1**: 用户必须填写所有必填项才能成功发布商品。
*   [ ] **验收标准2**: 用户只能从系统预设的分类和标签列表中进行选择。
*   [ ] **验收标准3**: 系统必须对上传的图片进行校验和处理。
*   [ ] **验收标准4**: 新发布的商品状态默认为“在售”。

### 2.5. 发布管理模块（整合原 FP5~FP7） (Function Points 5~7)

本模块统一覆盖“我发布的商品列表浏览、商品信息编辑、商品上下架”三类能力，整合原 2.5 / 2.6 / 2.7 的全部业务与验收要求。

1. **用户故事集合**:
   * 列表：作为卖家，我希望集中查看我发布的所有商品，并支持搜索与状态管理操作。
   * 编辑：作为卖家，我希望修改未售出的商品信息（价格、描述等），而不改变其状态。
   * 上/下架：作为卖家，我希望临时下架或重新上架我的商品，以灵活控制其可见性；已售终态不可再变更。
2. **前置条件**:
   * 通用：用户已登录。
   * 编辑 / 上下架操作：用户必须是该商品的发布者，且商品状态满足对应规则（编辑仅限“在售”或“已下架”；上下架仅在允许的状态间流转）。
3. **后置条件**:
   * 列表浏览：无状态变化。
   * 编辑：商品字段更新，状态保持不变。
   * 上下架：商品状态在数据库中发生合法流转（在售→已下架 / 已下架→在售）。
4. **界面与交互**:
   * 列表页（“我发布的商品”）：
     * 顶部搜索框：支持商品标题模糊搜索。
     * 列表分页：每页 10 条，按发布时间倒序。
     * 卡片字段：主图、标题、价格、当前状态（在售/已售/已下架）。
     * 操作按钮按状态动态呈现：
       * 在售：编辑、下架。
       * 已下架：编辑、重新上架。
       * 已售：编辑按钮禁用（或隐藏编辑入口），无状态管理按钮，显著“已售出”标签。
     * 空状态：无商品时展示引导“去发布”。
   * 编辑页：与“发布新商品”表单结构一致，所有字段预填；提供“保存修改 / 取消”按钮。保存仅更新允许编辑的字段，不触发状态改变。
   * 上/下架交互：
     * 触发按钮后弹二次确认对话框。
     * 成功后显示 3 秒撤销提示横幅（“已下架/已上架，可撤销(3s)”）。撤销按钮在时间窗内可点击，触发回滚接口。
     * 撤销失败场景（超时或状态冲突）给出明确原因。
5. **业务流程**:
   * A. 列表浏览：进入页面→查询该用户所有商品（含在售/已下架/已售）按发布时间倒序→展示分页→用户可搜索→动态按钮依状态呈现。
   * B. 编辑：列表点击编辑→权限与状态校验→加载编辑页面→用户修改→提交→后端字段校验与状态合法性验证→更新数据（不改状态）→返回成功→跳转回列表并刷新。已售商品直接拒绝（终态）。
   * C. 上/下架：列表点击对应按钮→弹确认→用户确认→后端校验发布者身份与当前状态→执行状态流转（在售→已下架 / 已下架→在售）→返回成功→前端更新状态→显示撤销提示→若 3 秒内点击撤销且无冲突→回滚为原状态；若冲突（例如被标记已售）→撤销失败，返回 409 与错误码。
6. **权限与状态规则（引用 1.3 状态机）**:
   * 已售为终态：不可编辑、不可重新上架、不可下架、不可撤销回滚至非终态。
   * 可编辑：仅“在售”与“已下架”。
   * 状态流转允许：在售↔已下架；已售无任何流转。
   * 撤销仅适用于当前刚完成的“上/下架”操作，已售冲突或其他外部改变导致 409 时撤销失败。
7. **异常 / 分支流程**:
   * 无发布商品：显示空状态与“去发布”引导。
   * 非发布者访问编辑 / 状态操作：拒绝，提示“您无权操作该商品”。
   * 编辑已售商品：拒绝，提示“已售商品无法编辑”。
   * 非法状态流转（如尝试下架已售）：前端按钮禁用或不显示，后端仍校验并返回“当前状态不允许此操作”。
   * 输入字段校验失败：逐项错误提示。
   * 撤销冲突：返回 HTTP 409 + 错误码 `PRODUCT_STATE_TRANSITION_FORBIDDEN`，提示原因。
   * 撤销超时：界面提示“已超过可撤销时间”。
8. **重要说明**:
   * 已售商品再次售卖需新建商品记录；不得通过任何接口恢复为“在售”或“已下架”。
   * 本模块不涉及库存锁定/订单/支付逻辑；相关限制（原“锁定”等）已删除。
9. **验收标准（合并 & 去重）**:
    * [ ] **验收标准1**: 列表仅展示当前登录用户的商品（含全部状态）。
    * [ ] **验收标准2**: 列表分页每页 10 条，按发布时间倒序；搜索与分页可组合，不互斥。
    * [ ] **验收标准3**: 支持商品标题模糊搜索并正确过滤结果集。
    * [ ] **验收标准4**: 每条记录正确展示状态并按状态呈现对应操作按钮，行为与 1.3 状态机一致。
    * [ ] **验收标准5**: “在售”与“已下架”商品可进入编辑页；“已售”商品编辑入口禁用或隐藏且后端拒绝编辑请求。
    * [ ] **验收标准6**: 编辑成功仅更新允许字段，不改变商品当前状态。
    * [ ] **验收标准7**: 后端对编辑与状态变更请求执行身份（发布者）+ 状态合法性双重校验，非法请求被拒绝并返回明确错误。
    * [ ] **验收标准8**: 在售→已下架、已下架→在售流转合法且成功后列表实时刷新展示新状态。
    * [ ] **验收标准9**: 已售商品不出现任何状态管理按钮，且不可编辑或重新上架。
    * [ ] **验收标准10**: 所有上下架操作均有二次确认弹窗，用户需明确确认后才提交后端。
    * [ ] **验收标准11**: 成功的上下架操作提供 3 秒撤销时间窗；在无冲突且时间窗内撤销可成功恢复原状态。
    * [ ] **验收标准12**: 撤销冲突（例如已被标记为已售）时返回 HTTP 409，错误码 `PRODUCT_STATE_TRANSITION_FORBIDDEN` 并前端提示失败原因。
    * [ ] **验收标准13**: 输入数据（编辑字段）校验失败时前端逐项展示错误，不更新任何商品数据。
    * [ ] **验收标准14**: 已售终态不可被任何接口更改或撤销；后端若收到相关尝试一律拒绝。
    * [ ] **验收标准15**: 空列表与权限失败场景均呈现明确友好 UI 提示（含操作引导或原因说明）。
    * [ ] **验收标准16**: 模块内不出现“已锁定”相关逻辑与文案；用户不会看到与锁定/订单/支付相关的遗留术语。
    * [ ] **验收标准17**: 撤销超时后横幅自动消失或提示“已超过可撤销时间”，按钮不可再触发撤销请求。
10. **追溯说明**: 本验收标准涵盖原 FP5（列表）、FP6（编辑）、FP7（上下架与撤销）全部要求，并保持原细致程度；删除项已标注为“无锁定/订单”逻辑，不影响核心业务。

> 注：为了保持后续章节编号稳定，原 2.6 与 2.7 已合并入本模块，不重新排列后续条目编号；功能点标识以集合方式说明 (Function Points 5~7)。

### 2.8. 商品首页浏览 (Function Point 8)

1.  **用户故事**: 作为一个用户，我希望能浏览一个展示最新发布商品的首页，如果我登录了，我还希望能看到系统为我推荐的商品。
2.  **前置条件**: 无。访客和登录用户均可访问。
3.  **后置条件**: 无状态变更。
4.  **界面及交互**:
    *   **页面布局**:
        *   顶部有导航和搜索框。
        *   有“商品分类”模块入口。
        *   主体为“最新发布”商品列表，以卡片形式展示。
        *   （仅登录用户可见）有独立的“猜你喜欢”商品模块。
    *   页面统一采用分页加载（每页20个）+ 图片懒加载；不使用无限滚动（课程项目可忽略SEO）。
5.  **业务流程**:
    1.  用户访问首页。
    2.  未登录用户：展示“最新发布”在售商品列表（分页，按发布时间倒序）。
    3.  登录用户：
        * 先获取“猜你喜欢”推荐模块（5-10条，仅在售，排除用户自发）。
        * 再加载“最新发布”在售商品列表（分页，按发布时间倒序），并对该列表进行跨模块去重，排除已在推荐模块展示的商品。
        * 保证分页过程中持续保持与推荐模块的去重一致性（同一页面视图内不出现重复商品）。
6.  **异常/分支流程**:
    *   **无任何商品**: 页面显示空状态提示。

*   [ ] **验收标准1**: 首页默认展示按发布时间倒序的在售商品列表。
*   [ ] **验收标准2**: 登录用户可以看到一个独立的“猜你喜欢”推荐模块。
*   [ ] **验收标准3**: 页面必须采用分页加载（每页20个）和图片懒加载以优化性能；不使用无限滚动。
*   [ ] **验收标准4**: 未登录用户可以浏览首页，但看不到推荐模块。
*   [ ] **验收标准5**: 推荐模块与最新发布模块不出现重复商品（同一页面视图内跨模块去重成立，且在分页过程中保持）。

### 2.9. 商品搜索 (Function Point 9)

1.  **用户故事**: 作为一个用户，我希望能通过输入关键词，搜索我感兴趣的商品。
2.  **前置条件**: 无。
3.  **后置条件**: 跳转到搜索结果页。
4.  **界面及交互**:
    *   **搜索框**: 位于全站顶部导航栏。
    *   **搜索结果页**:
        *   显示当前搜索的关键词。
        *   以商品卡片列表展示搜索结果。
        *   顶部提供筛选与排序栏：
            *   筛选：价格区间（最小价/最大价）、发布时间（如近7天/近30天，可选）。
            *   排序：最新发布（默认）、价格从低到高、价格从高到低。
        *   分页加载。
5.  **业务流程**:
    1.  用户在搜索框输入关键词并按回车或点击搜索按钮。
    2.  系统根据关键词对在售商品的标题、描述、分类、标签进行模糊匹配。
    3.  系统将匹配结果按所选排序规则排列（默认按发布时间倒序），并展示在结果页。
6.  **异常/分支流程**:
    *   **无搜索结果**: 页面显示“未找到相关商品”的提示。
    *   **空关键词搜索**: 返回所有在售商品列表。

*   [ ] **验收标准1**: 搜索功能可以匹配商品的标题、描述、分类和标签。
*   [ ] **验收标准2（更新）**: 搜索结果只包含"在售"商品，并支持排序（最新/价格升序/价格降序）；默认按发布时间倒序。
*   [ ] **验收标准3**: 搜索结果页必须采用分页加载（每页20个）。
*   [ ] **验收标准4（新增）**: 结果页支持价格区间筛选，筛选条件与排序共同作用于列表。

### 2.10. 查看商品详情 (Function Point 10)

1.  **用户故事**: 作为一个用户，我希望能点击任意商品，查看其完整的图文信息、价格、标签以及卖家信息。
2.  **前置条件**: 无。
3.  **后置条件**: 无状态变更。
4.  **界面及交互**:
    *   **页面布局**:
        *   **商品核心区**: 图片轮播、标题、价格、新旧程度、分类、标签、详细描述。
    *   **卖家信息区**: 卖家头像和昵称（仅展示，无链接）。
    *   **操作区**: "联系卖家"按钮。
        *   访客（未登录）：点击"联系卖家"弹出登录框，引导完成登录后再继续原动作。
        *   发布者本人（卖家访问自己的商品）：隐藏"联系卖家"入口。
    *   **状态横幅规则**：
        *   当商品状态为`已售`/`已下架`时，详情页顶部展示显著状态横幅（例：“此商品已售出/已下架”）。
5.  **业务流程**:
    1.  用户在任意商品列表点击一个商品。
    2.  系统加载并展示该商品的全部详情。
    3.  系统记录登录用户的浏览行为（插入 `user_recent_views` 表），用于推荐分析。
6.  **异常/分支流程**:
    *   **访问不存在的商品**: 页面显示“商品不存在或已被删除”。
    *   **访问非在售商品**: 页面正常打开并展示状态横幅，购买相关按钮禁用（见“状态横幅/禁用规则”）。
    *   **页面一致性**: 无论访问者是谁（买家/卖家/访客），详情页布局和内容保持一致，不显示卖家管理按钮。
    *   **未登录行为引导**：未登录用户点击“收藏/立即下单/联系卖家”，统一弹出登录框；登录成功后回到当前商品详情并继续原始操作（可选）。
    *   **卖家本人访问**：在自己发布的商品详情页，隐藏“立即下单/联系卖家”。

*   [ ] **验收标准1**: 页面必须完整、准确地展示商品的所有信息。
*   [ ] **验收标准2**: 卖家信息区展示卖家头像和昵称，仅用于展示，不提供跳转功能。
*   [ ] **验收标准3（更新）**: 所有用户均可访问任意商品详情页链接；当商品状态为`已售`/`已下架`时，页面顶部展示显著状态横幅。
*   [ ] **验收标准4**: 登录用户的浏览行为被系统记录。
*   [ ] **验收标准5（更新）**: 未登录用户在详情页点击"联系卖家"时，弹出登录框。
*   [ ] **验收标准6（更新）**: 自己发布的商品进入详情页，不显示"联系卖家"入口。

### 2.11. 个性化商品推荐 (Function Point 11)

1.  **用户故事**: 作为一个登录用户，我希望系统在首页"猜你喜欢"模块推荐与我最近浏览过的商品标签相关的商品，能基本反映我近期的兴趣。
2.  **前置条件**: 用户必须处于登录状态。
3.  **后置条件**: 无状态变更。
4.  **界面及交互**:
    * 首页有独立"猜你喜欢"模块，展示5-10个推荐商品卡片；不足时用"最新发布在售"补齐。
5.  **业务流程**:
    1. **浏览记录**：
        * 当用户浏览商品详情页时，系统在 `user_recent_views` 表中插入一条记录（user_id, product_id, viewed_at）。
        * 每个用户最多保留最近 20 条浏览记录，超过时自动删除最旧的记录。
    2. **首页推荐**：
        * 查询该用户最近浏览的 20 条商品记录。
        * 提取这些商品的所有标签，统计每个标签的出现次数，选择 Top 3-5 个高频标签。
        * 在"在售"商品中查找：标签包含上述任一高频标签的商品，排除用户自己发布的商品。
        * 按发布时间倒序排列，取前 10 条作为推荐结果。
        * 若推荐结果不足 5 条，用"最新发布在售"商品补齐到 5-10 条。
    3. **返回前处理**：去重、仅保留"在售"状态、排除用户自己发布的商品；用于首页展示时与"最新发布"模块进行跨模块去重（推荐优先，最新发布列表排除已在推荐模块展示的商品）。
6.  **异常/分支流程**:
    * **冷启动**：新用户或无浏览记录的用户，直接展示"最新发布在售"商品。
    * **数据不足**：推荐结果不足时，用"最新发布在售"补齐；不阻塞首页渲染。
    * **内容排除**：推荐结果中不包含用户自己发布的商品。
7.  **数据表设计**:
    * **user_recent_views** 表：
        * 字段：`id`, `user_id`, `product_id`, `viewed_at`
        * 主键：`id`
        * 索引：`(user_id, viewed_at DESC)` 用于快速查询用户最近浏览记录
        * 外键：`user_id` 关联 users 表，`product_id` 关联 products 表
    * **维护策略**：
        * 插入新记录时，检查该用户的记录数，若超过 20 条则删除最旧的记录。
        * 或使用定时任务（可选）清理旧记录。
8.  **验收标准**:
    * [ ] **验收标准1**: 推荐逻辑仅基于用户最近 20 条浏览记录，通过商品标签进行匹配。
    * [ ] **验收标准2**: 推荐结果仅包含"在售"商品，且排除用户自己发布的商品。
    * [ ] **验收标准3**: 推荐结果数量不足 5 条时，用"最新发布在售"商品补齐到 5-10 条。
    * [ ] **验收标准4**: 冷启动场景（无浏览记录）能正常展示"最新发布在售"商品。
    * [ ] **验收标准5**: 每个用户最多保留 20 条浏览记录，超过时自动删除最旧记录。
    * [ ] **验收标准6**: 推荐结果按发布时间倒序排列，不使用复杂评分或时间衰减算法。

### 2.14. 商品分类浏览 (Function Point 14)

1.  **用户故事**: 作为一个用户，我希望能通过点击预设的分类来浏览该类别下的所有商品。
2.  **前置条件**: 无。
3.  **后置条件**: 跳转到分类商品列表页。
4.  **界面及交互**:
    *   **首页**: 有一个分类模块，展示所有分类入口。
    *   **分类列表页**: 显示分类名称，并以商品卡片列表展示该分类下的所有在售商品；提供筛选与排序栏（同搜索结果页）：
        * 筛选：价格区间（最小价/最大价）。
        * 排序：最新发布（默认）、价格从低到高、价格从高到低。
5.  **业务流程**:
    1.  用户在首页点击一个分类。
    2.  系统加载并展示该分类下的所有在售商品，并按所选排序规则排列（默认按发布时间倒序）。
6.  **异常/分支流程**:
    *   **分类下无商品**: 页面显示空状态提示。

*   [ ] **验收标准1**: 用户可以通过点击分类，查看对应分类下的所有在售商品。
*   [ ] **验收标准2**: 分类列表页采用分页加载（每页20个）。
*   [ ] **验收标准3（新增）**: 分类页支持价格区间筛选与排序（最新/价格升序/价格降序）。

### 2.15. 后台综合管理系统 (Admin Dashboard)

1.  **用户故事**: 作为一个管理员，我需要一个后台系统来查看平台的整体数据，并对用户、商品、分类和标签进行基本的查看与维护，以保证平台的正常运营。
2.  **前置条件**: 用户必须拥有管理员权限并已登录后台。
3.  **后置条件**: 对用户、商品、分类、标签数据的基本增删改查（删除受引用约束）。
4.  **界面及交互**:
    *   **多模块界面**: 包含仪表盘、用户管理、商品管理、分类管理、标签管理等模块。
    *   **数据展示**: 主要以表格和列表形式展示数据（支持分页、搜索、简单筛选）。
    *   **操作**: 主要提供查看、搜索、编辑、删除、新增分类/标签等基础管理操作；不提供前台业务逻辑相关的“封禁用户”“强制下架商品”等复杂能力。
5.  **业务流程**:
    *   管理员登录后台，通过左侧菜单切换不同管理模块。
    *   在各模块中执行相应的管理操作。
    *   删除分类/标签流程：
        1. 后端检查该分类/标签是否被商品引用（关联商品数量）。
        2. 若计数为 0：弹出删除确认，确认后直接删除。
        3. 若计数 > 0：拒绝删除，提示"该分类/标签已被引用，无法删除"。
6.  **异常/分支流程**:
    *   **无权限访问**: 拒绝访问。
    *   **删除被引用的分类/标签**: 返回 HTTP 409（Conflict），错误码：`CATEGORY_DELETE_FORBIDDEN_REFERENCED` / `TAG_DELETE_FORBIDDEN_REFERENCED`，提示"该分类/标签已被引用，无法删除"。

*   [ ] **验收标准1**: 管理员可以查看系统核心数据指标（如用户数、商品数等）。
*   [ ] **验收标准2**: 管理员可以对用户和商品进行搜索与列表查看。
*   [ ] **验收标准3**: 管理员可以对分类和标签进行增、改、查。
*   [ ] **验收标准4**: 当分类/标签未被商品引用时可以删除；被引用时删除请求被拒绝并返回明确提示。

### 2.16. 商品分类浏览 (Function Point 14)

1.  **用户故事**: 作为一个用户，我希望能通过点击预设的分类来浏览该类别下的所有商品。
2.  **前置条件**: 无。
3.  **后置条件**: 跳转到分类商品列表页。
4.  **界面及交互**:
    *   **首页**: 有一个分类模块，展示所有分类入口。
    *   **分类列表页**: 显示分类名称，并以商品卡片列表展示该分类下的所有在售商品；提供筛选与排序栏（同搜索结果页）：
        * 筛选：价格区间（最小价/最大价）。
        * 排序：最新发布（默认）、价格从低到高、价格从高到低。
5.  **业务流程**:
    1.  用户在首页点击一个分类。
    2.  系统加载并展示该分类下的所有在售商品，并按所选排序规则排列（默认按发布时间倒序）。
6.  **异常/分支流程**:
    *   **分类下无商品**: 页面显示空状态提示。

*   [ ] **验收标准1**: 用户可以通过点击分类，查看对应分类下的所有在售商品。
*   [ ] **验收标准2**: 分类列表页采用分页加载（每页20个）。
*   [ ] **验收标准3（新增）**: 分类页支持价格区间筛选与排序（最新/价格升序/价格降序）。

## 附录
