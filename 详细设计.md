## 1. 引言

### 1.1 编写目的

本软件详细设计说明书在《概要设计》的基础上，对校园二手交易推荐系统的各个模块（用户、商品、推荐、分类/标签、后台管理等）给出类（结构体）级、接口级的详细设计，包含：

- 主要后端模块的包结构、核心结构体与方法；
- 关键 REST API 的 URL、HTTP 方法、请求/响应字段、错误码；
- 数据库表的字段级设计与约束；
- 重要业务流程的处理步骤和伪代码；
- 前后端交互契约与状态/错误处理规则。

开发人员可直接依据本设计编写后端 Go 代码与前端 Vue 代码；测试人员可依据接口与状态机设计编写测试用例；后续维护人员可根据本设计理解系统行为。

### 1.2 适用读者

- 后端开发人员（Go + Gin）；
- 前端开发人员（Vue3 + TypeScript）；
- 测试人员；
- 教师/评审人员；
- 运维与后续维护人员。

### 1.3 参考文档

- 《PRD.md》：校园二手交易推荐系统产品需求文档；
- 《概要设计.md》：本系统总体架构与模块划分；
- Gin 官方文档；
- Vue3 / Vite / Pinia 官方文档；
- PostgreSQL 官方文档。

---

## 2. 系统总体设计回顾（与概要设计的衔接）

本节简要复述与详细设计强相关的总体设计要点，便于后续章节引用。

### 2.1 分层结构与包划分

后端采用“三层 + 公共模块”的结构：

- **Controller 层**：HTTP 入口，负责路由绑定、入参解析和基本校验；
- **Service 层**：业务逻辑层，负责状态机校验、事务控制、组合多个仓库操作；
- **Repository 层**：持久化层，封装对 PostgreSQL 的访问；
- **Common 层**：统一响应结构、错误码、鉴权中间件、工具方法等。

后端目录结构（约定）：

```text
backend/
	cmd/
	config/
	router/
	middleware/
	controller/
		user/
		product/
		recommend/
		category/
		tag/
		admin/
	service/
		user/
		product/
		recommend/
		category/
		tag/
		admin/
	repository/
	model/
	common/
		resp/
		errors/
		auth/
		util/
```

前端采用 Vue3 + TS + Vite，主要目录：

```text
frontend/src/
	api/
	views/
		home/
		product/
		search/
		category/
		user/
	components/
	store/
	router/
admin-frontend/src/
	api/
	views/
		dashboard/
		user/
		product/
		category/
		tag/
	components/
	store/
	router/
```

后续每个功能点的详细设计，将同时给出后端接口定义与前端调用约定。

### 2.2 状态机与全局规则

**商品状态机**（来自 PRD 1.3）：

- 状态：`ForSale`（在售）、`Sold`（已售）、`Delisted`（已下架）；
- 允许流转：
	- `ForSale` → `Delisted`（卖家下架）；
	- `ForSale` → `Sold`（线下成交后卖家标记已售，终态）；
	- `Delisted` → `ForSale`（卖家重新上架）；
- 终态：`Sold`，一旦进入禁止任何变更，包括编辑、上下架、撤销；
- 可编辑：仅 `ForSale` 与 `Delisted`；
- 推荐、搜索、分类列表只展示 `ForSale` 商品。

**一物一件规则**：

- 每条 `products` 记录仅代表一件实体商品；
- 无库存字段，不存在“多件库存”。

---

## 3. 数据库详细设计

本节在概要设计概念 ER 的基础上，给出字段级别的表设计与约束，可直接据此编写建表 SQL 或迁移脚本。

### 3.1 users 表

- 作用：存储学生用户和管理员用户的账号信息。

字段设计：

| 字段名 | 类型 | 约束 | 含义 |
|--------|------|------|------|
| id | BIGSERIAL | PK | 用户 ID，自增主键 |
| account | VARCHAR(32) | NOT NULL, UNIQUE | 登录账号，仅允许字母和数字 |
| nickname | VARCHAR(32) | NOT NULL | 昵称，可重复 |
| password_hash | VARCHAR(128) | NOT NULL | 密码哈希（例如 bcrypt） |
| avatar_url | VARCHAR(255) | NULL | 头像 URL |
| is_admin | BOOLEAN | NOT NULL DEFAULT FALSE | 是否为管理员 |
| last_nickname_changed_at | TIMESTAMP | NULL | 上次修改昵称时间，用于 30 天限制 |
| created_at | TIMESTAMP | NOT NULL DEFAULT NOW() | 创建时间 |
| updated_at | TIMESTAMP | NOT NULL DEFAULT NOW() | 更新时间 |

约束与索引：

- `UNIQUE(account)` 保证登录账号全局唯一；
- 可选索引：`INDEX idx_users_account(account)` 提升登录查询效率。

### 3.2 products 表

- 作用：记录商品基本信息与状态。

字段设计：

| 字段名 | 类型 | 约束 | 含义 |
|--------|------|------|------|
| id | BIGSERIAL | PK | 商品 ID |
| seller_id | BIGINT | NOT NULL, FK -> users(id) | 发布者用户 ID |
| title | VARCHAR(100) | NOT NULL | 商品标题 |
| description | TEXT | NOT NULL | 商品描述 |
| price | NUMERIC(10,2) | NOT NULL | 商品价格 |
| condition | VARCHAR(20) | NOT NULL | 新旧程度，如“全新”“九成新”等 |
| category_id | BIGINT | NOT NULL, FK -> categories(id) | 分类 ID |
| status | VARCHAR(16) | NOT NULL | `ForSale` / `Sold` / `Delisted` |
| main_image_url | VARCHAR(255) | NULL | 主图 URL（首张图片） |
| created_at | TIMESTAMP | NOT NULL DEFAULT NOW() | 发布时间 |
| updated_at | TIMESTAMP | NOT NULL DEFAULT NOW() | 最近更新时间 |

约束与索引：

- 外键：`seller_id` → `users(id)`，`category_id` → `categories(id)`；
- 状态取值通过应用层保证三种合法值；
- 索引：
	- `INDEX idx_products_seller(seller_id)` 支持“我发布的商品”；
	- `INDEX idx_products_status_created_at(status, created_at DESC)` 支持首页/搜索；
	- `INDEX idx_products_category_status(category_id, status)` 支持分类浏览。

### 3.3 product_images 表

- 作用：存储商品多张图片。

字段设计：

| 字段名 | 类型 | 约束 | 含义 |
|--------|------|------|------|
| id | BIGSERIAL | PK | 主键 |
| product_id | BIGINT | NOT NULL, FK -> products(id) | 商品 ID |
| url | VARCHAR(255) | NOT NULL | 图片 URL |
| sort_order | INT | NOT NULL DEFAULT 0 | 图片排序序号 |

索引：

- `INDEX idx_product_images_product(product_id, sort_order)`。

### 3.4 categories 表

| 字段名 | 类型 | 约束 | 含义 |
|--------|------|------|------|
| id | BIGSERIAL | PK | 分类 ID |
| name | VARCHAR(50) | NOT NULL, UNIQUE | 分类名称 |
| description | VARCHAR(255) | NULL | 分类描述 |
| created_at | TIMESTAMP | NOT NULL DEFAULT NOW() | 创建时间 |
| updated_at | TIMESTAMP | NOT NULL DEFAULT NOW() | 更新时间 |

删除约束：

- 删除前必须检查 `products` 表中 `category_id` 引用计数（通过应用逻辑实现）；
- 被引用时禁止删除，返回指定错误码。

### 3.5 tags & product_tags 表

`tags` 表：

| 字段名 | 类型 | 约束 | 含义 |
|--------|------|------|------|
| id | BIGSERIAL | PK | 标签 ID |
| name | VARCHAR(50) | NOT NULL, UNIQUE | 标签名称 |
| created_at | TIMESTAMP | NOT NULL DEFAULT NOW() | 创建时间 |
| updated_at | TIMESTAMP | NOT NULL DEFAULT NOW() | 更新时间 |

`product_tags` 表（多对多关系）：

| 字段名 | 类型 | 约束 | 含义 |
|--------|------|------|------|
| product_id | BIGINT | NOT NULL, FK -> products(id) | 商品 ID |
| tag_id | BIGINT | NOT NULL, FK -> tags(id) | 标签 ID |

约束与索引：

- 复合主键：`PRIMARY KEY(product_id, tag_id)` 防止重复；
- 索引：`INDEX idx_product_tags_tag(tag_id)` 支持根据标签查商品。

### 3.6 user_recent_views 表

| 字段名 | 类型 | 约束 | 含义 |
|--------|------|------|------|
| id | BIGSERIAL | PK | 主键 |
| user_id | BIGINT | NOT NULL, FK -> users(id) | 用户 ID |
| product_id | BIGINT | NOT NULL, FK -> products(id) | 商品 ID |
| viewed_at | TIMESTAMP | NOT NULL | 浏览时间 |

索引与维护策略：

- 索引：`INDEX idx_views_user_time(user_id, viewed_at DESC)`；
- 维护：每次插入后查询该用户记录数 > 20 时删除最旧记录（应用层实现），或定期清理。

### 3.7 其他辅助表

可选增加登录会话表 `sessions`（若不使用纯 JWT）：

| 字段名 | 类型 | 约束 | 含义 |
|--------|------|------|------|
| id | BIGSERIAL | PK | 会话 ID |
| user_id | BIGINT | NOT NULL | 用户 ID |
| token | VARCHAR(128) | NOT NULL, UNIQUE | 会话 token |
| expired_at | TIMESTAMP | NOT NULL | 过期时间 |

使用 Redis 存储会话时，可不建此表；本项目可采用“后端签发 JWT + Redis 缓存”的简化方案，不强制实现服务端会话表。

---

## 4. 公共设计

### 4.1 统一响应结构

所有后端接口返回统一 JSON 结构：

```json
{
	"code": 0,
	"message": "ok",
	"data": {}
}
```

- `code`：业务状态码，`0` 表示成功，其余为错误；
- `message`：对用户或开发者友好的提示；
- `data`：具体业务数据（对象或数组）。

常用错误码（部分）：

| code | 语义 |
|------|------|
| 0 | 成功 |
| 1001 | 参数校验失败 |
| 1002 | 未登录或 token 无效 |
| 1003 | 权限不足 |
| 2001 | 账号已存在 |
| 2002 | 账号或密码错误 |
| 3001 | 商品不存在 |
| 3002 | 非发布者，无权操作该商品 |
| 3003 | 商品状态不允许此操作 |
| 3004 | 已售商品禁止编辑或状态变更 |
| 3005 | 撤销超时或冲突（状态已变更） |
| 4001 | 分类被引用，无法删除 |
| 4002 | 标签被引用，无法删除 |

对应 PRD 中的错误码 `PRODUCT_STATE_TRANSITION_FORBIDDEN` 等，可在实现时通过错误码和 message 映射。

### 4.2 鉴权中间件与会话

后端通过 `AuthMiddleware` 鉴权：

- 从请求头 `Authorization: Bearer <token>` 读取 token；
- 验证 token 签名与过期时间；
- 解析出 `userId` 和 `isAdmin` 等信息，放入 Gin Context；
- 对需要登录的接口，若未通过鉴权则返回 `code=1002`；
- 对仅限管理员的接口，检查 `isAdmin=true`，否则返回 `code=1003`。

前端在登录成功后将 token 缓存到 `localStorage` 或 `cookie`，并在后续请求中自动附带 Authorization 头；“记住我”选项影响 token 有效期。

---

## 5. 用户模块详细设计（FP1、FP2、FP3）

### 5.1 后端类与接口设计

#### 5.1.1 模型结构体

`model/user.go`：

- 结构 `User`：

- 字段：
	- `ID int64`
	- `Account string`
	- `Nickname string`
	- `PasswordHash string`
	- `AvatarURL string`
	- `IsAdmin bool`
	- `LastNicknameChangedAt *time.Time`
	- `CreatedAt time.Time`
	- `UpdatedAt time.Time`

#### 5.1.2 Repository 接口

`repository/user_repo.go`：

- 接口 `UserRepository`：
	- `GetByAccount(ctx, account) (*User, error)`：根据账号查询用户；
	- `GetByID(ctx, id) (*User, error)`：根据 ID 查询用户；
	- `Create(ctx, user *User) error`：插入新用户；
	- `UpdateProfile(ctx, user *User) error`：更新昵称和头像；
	- `UpdatePassword(ctx, userID int64, newHash string) error`；
	- `UpdateLastNicknameChangedAt(ctx, userID int64, t time.Time) error`。

实现时使用 GORM 或 `database/sql`，保证唯一性与并发安全。

#### 5.1.3 Service 接口

`service/user/service.go`：

- 结构 `UserService`：依赖 `UserRepository` 和加密工具。

主要方法：

1. `Register(ctx, account, nickname, password string) (*User, string, error)`

	 - 处理流程：
		 1. 校验账号格式（字母数字）与密码长度 ≥ 8；
		 2. 查询账号是否已存在；
		 3. 使用 bcrypt 生成密码哈希；
		 4. 构造 `User` 对象并调用 `repo.Create` ；
		 5. 生成登录 token 并返回用户信息 + token。

2. `Login(ctx, account, password string, remember bool) (*User, string, error)`

	 - 流程：
		 1. 根据账号查询用户；
		 2. 使用 bcrypt 比对密码；
		 3. 生成 token（带有效期，若 remember=true 则延长）；
		 4. 返回用户信息与 token。

3. `UpdateProfile(ctx, userID int64, nickname *string, avatarURL *string) (*User, error)`

	 - 流程：
		 1. 查询用户；
		 2. 如果 nickname 非空，检查距离上次修改是否 ≥ 30 天；
		 3. 更新字段，写回数据库；
		 4. 返回更新后的用户信息。

4. `ChangePassword(ctx, userID int64, oldPassword, newPassword string) error`

	 - 流程：
		 1. 查询用户，并用 bcrypt 校验旧密码；
		 2. 校验新密码长度 ≥ 8；
		 3. 生成新密码哈希并更新；
		 4. 保持当前 token 有效（按 PRD 要求）。

#### 5.1.4 Controller 设计

`controller/user/controller.go`：

路由（示例）：

- `POST /api/v1/users/register` → `Register()`
- `POST /api/v1/users/login` → `Login()`
- `GET /api/v1/users/profile` → `GetProfile()`（需要登录）
- `PUT /api/v1/users/profile` → `UpdateProfile()`（需要登录）
- `PUT /api/v1/users/password` → `ChangePassword()`（需要登录）

各方法参数与响应：

1. **注册** `POST /api/v1/users/register`

	 - 请求体 JSON：
		 - `account`: string
		 - `nickname`: string
		 - `password`: string
		 - `confirmPassword`: string
	 - 校验：非空、两次密码一致、账号格式、密码长度 ≥ 8；
	 - 调用 `UserService.Register`；
	 - 成功响应：`{ code:0, data:{ user:{id, account, nickname, avatarUrl}, token } }`；
	 - 失败场景：
		 - 账号存在 → `code=2001`；
		 - 格式错误 → `code=1001`；
		 - 其他内部错误 → `code` 统一归为 `5000`（内部错误）。

2. **登录** `POST /api/v1/users/login`

	 - 请求体：
		 - `account`: string
		 - `password`: string
		 - `rememberMe`: boolean
	 - 调用 `UserService.Login`；
	 - 成功响应：同注册；
	 - 失败：账号或密码错误 → `code=2002`，不区分具体原因。

3. **获取个人信息** `GET /api/v1/users/profile`

	 - 从鉴权中间件获得 `userID`；
	 - 查询并返回用户信息。

4. **更新个人信息** `PUT /api/v1/users/profile`

	 - 请求体：
		 - `nickname?`: string
		 - `avatarUrl?`: string
	 - 调用 `UserService.UpdateProfile`；
	 - 昵称频率限制不满足时返回 `code=1001` 和明确 message。

5. **修改密码** `PUT /api/v1/users/password`

	 - 请求体：
		 - `oldPassword`: string
		 - `newPassword`: string
		 - `confirmPassword`: string
	 - 校验：新密码长度、两次一致；
	 - 调用 `UserService.ChangePassword`；
	 - 旧密码错误返回 `code=1001`，message：“当前密码不正确”。

### 5.2 前端页面与接口调用

#### 5.2.1 注册页

路由：`/register`

主要组件：

- 表单字段：账号、昵称、密码、确认密码；
- 校验规则：必填、账号正则、密码长度、两次密码一致；
- 调用 `POST /api/v1/users/register`，成功后：
	- 将 token 和用户信息存入 `store/user`；
	- 跳转到首页并显示“注册成功，已为您自动登录”。

#### 5.2.2 登录页

路由：`/login`

- 表单字段：账号、密码、记住我；
- 校验：必填；
- 调用 `POST /api/v1/users/login`，成功后跳转首页；
- 错误信息展示：“登录账号或密码不正确”。

#### 5.2.3 个人中心

路由：`/profile`

- 显示当前头像与昵称；
- “更换头像”触发图片上传组件：上传完毕获取 URL，再调用 `PUT /api/v1/users/profile` 更新；
- “修改昵称”弹出输入框并调用同一接口；
- “修改密码”表单调用 `PUT /api/v1/users/password`。

---

## 6. 商品模块详细设计（FP4、FP5~7、FP8、FP9、FP10）

### 6.1 后端类与接口设计

#### 6.1.1 模型结构体

`model/product.go`：

- 结构 `Product`：
	- `ID int64`
	- `SellerID int64`
	- `Title string`
	- `Description string`
	- `Price float64`
	- `Condition string`
	- `CategoryID int64`
	- `Status string` // ForSale, Sold, Delisted
	- `MainImageURL string`
	- `CreatedAt time.Time`
	- `UpdatedAt time.Time`

- 结构 `ProductImage`：
	- `ID int64`
	- `ProductID int64`
	- `URL string`
	- `SortOrder int`

#### 6.1.2 Repository 接口

`repository/product_repo.go`：

- 接口 `ProductRepository`：
	- `Create(ctx, p *Product, images []ProductImage, tagIDs []int64) (int64, error)`：
		- 含事务：插入 products、product_images、product_tags；
	- `Update(ctx, p *Product, images []ProductImage, tagIDs []int64) error`：
		- 仅允许非 Sold 状态产品；
	- `GetByID(ctx, id int64) (*Product, error)`；
	- `ListBySeller(ctx, sellerID int64, keyword string, statusFilter *string, page, pageSize int) ([]Product, int, error)`；
	- `UpdateStatus(ctx, id int64, fromStatus, toStatus string) error`：
		- SQL 中带 where status=fromStatus；
	- `MarkSold(ctx, id int64) error`：
		- 将状态置为 Sold；
	- `Search(ctx, params SearchParams) ([]Product, int, error)`：
		- 支持关键词、价格区间、分类、排序；
	- `ListLatestForSale(ctx, excludeIDs []int64, page, pageSize int) ([]Product, int, error)`；
	- `ListByCategory(ctx, categoryID int64, params ListCategoryParams) ([]Product, int, error)`。

#### 6.1.3 Service 逻辑与状态机

`service/product/service.go`：

- 结构 `ProductService`：依赖 `ProductRepository`、`CategoryRepository`、`TagRepository`、文件上传服务等。

主要方法：

1. `CreateProduct(ctx, sellerID int64, req CreateProductReq) (*ProductDetailDTO, error)`

	 - 入参（业务结构）：
		 - `Title string`
		 - `Description string`
		 - `Price float64`
		 - `CategoryID int64`
		 - `TagIDs []int64`
		 - `Condition string`
		 - `Images []UploadedFile`（来自 Controller）
	 - 处理步骤：
		 1. 校验必填项非空，价格 > 0；
		 2. 校验分类与标签存在；
		 3. 校验图片数量、大小和格式（JPG/PNG，小于 2MB）；
		 4. 调用文件上传模块逐张上传，得到 URL 列表；
		 5. 构造 Product 与 ProductImage 切片；
		 6. 设置 `Status = ForSale`；
		 7. 调用 `repo.Create` 完成事务插入；
		 8. 返回包含图片与标签的 DTO。

2. `UpdateProduct(ctx, sellerID, productID int64, req UpdateProductReq) (*ProductDetailDTO, error)`

	 - 流程：
		 1. 查询商品，若不存在返回 `3001`；
		 2. 检查 `SellerID` 是否等于当前用户，否则 `3002`；
		 3. 检查状态，不允许 `Sold`；
		 4. 按请求更新可编辑字段（标题、描述、价格、分类、标签、图片）；
		 5. 若有新图片，上传并重建 image 列表；
		 6. 调用 `repo.Update`（内部事务更新 product, images, tags）；
		 7. 返回更新后的 DTO。

3. `ChangeStatus(ctx, sellerID, productID int64, action string) (*ProductDTO, error)`

	 - `action` 取值：`delist` / `relist` / `sold`；
	 - 逻辑：
		 - 查询商品，校验发布者；
		 - 若当前状态为 Sold，直接返回错误 `3004`；
		 - 根据 action 确定 `from` 与 `to`：
			 - `delist`: from=ForSale, to=Delisted；
			 - `relist`: from=Delisted, to=ForSale；
			 - `sold`: from=ForSale, to=Sold；
		 - 调用 `repo.UpdateStatus`，使用 where status=from；
		 - 根据影响行数判断是否状态不匹配；
		 - 返回更新后状态。

4. `UndoLastStatusChange(ctx, sellerID, productID int64) (*ProductDTO, error)`

	 - 为满足“3 秒内可撤销”需求，需要：
		 - 在应用层为每次上/下架操作写入短时缓存，记录“上次状态”；
		 - 如使用 Redis：键 `product:undo:{productID}:{sellerID}`，值为 `fromStatus->toStatus`；TTL=3秒；
	 - 逻辑：
		 1. 从缓存读取上次操作；若不存在则返回错误 `3005`；
		 2. 查询当前商品状态与 sellerID；
		 3. 若当前状态不等于缓存中的 `toStatus`，说明已经发生其他变更（如已售），返回错误 `3005` 与 message：`PRODUCT_STATE_TRANSITION_FORBIDDEN`；
		 4. 若 `toStatus` 为 Sold，则禁止撤销（终态），直接返回错误 `3004`；
		 5. 调用 `repo.UpdateStatus(id, toStatus, fromStatus)` 回滚；
		 6. 删除缓存键；
		 7. 返回回滚后的状态。

5. `GetProductDetail(ctx, productID int64, viewerID *int64) (*ProductDetailDTO, error)`

	 - 逻辑：
		 1. 查询商品与图片、标签、发布者信息；
		 2. 无论状态如何均可返回详情；
		 3. 若 `viewerID` 非空，则调用推荐模块记录浏览行为（`RecordView`）；
		 4. 构造 DTO：包含商品字段、图片列表、标签列表、卖家昵称/头像、是否发布者本人。

6. `SearchProducts(ctx, params SearchParams) ([]ProductCardDTO, int, error)`

	 - 只查询 `status=ForSale`；
	 - 支持模糊匹配标题、描述、分类名、标签名；
	 - 支持价格区间与排序。

7. `ListMyProducts(ctx, sellerID int64, keyword string, page, pageSize int) ([]ProductMyDTO, int, error)`

	 - 返回当前登录用户的所有商品（含在售/已下架/已售）；
	 - DTO 包含状态与允许的操作按钮标记（前端可据此渲染）。

#### 6.1.4 Controller 与 API 设计

`controller/product/controller.go`：

路由：

- `POST /api/v1/products`（登录）—— 发布商品（multipart/form-data）；
- `PUT /api/v1/products/:id`（登录）—— 编辑商品；
- `POST /api/v1/products/:id/status`（登录）—— 上/下架/标记已售；
- `POST /api/v1/products/:id/status/undo`（登录）—— 撤销最近一次上/下架；
- `GET /api/v1/products/:id`（公开）—— 获取商品详情；
- `GET /api/v1/products/my`（登录）—— 我发布的商品列表；
- `GET /api/v1/products/search`（公开）—— 搜索商品；
- `GET /api/v1/products/category/:categoryId`（公开）—— 分类浏览。

各接口细节：

1. **发布商品** `POST /api/v1/products`

	 - Content-Type: `multipart/form-data`；
	 - 字段：
		 - `title` (string, 必填)
		 - `description` (string, 必填)
		 - `price` (number, 必填)
		 - `categoryId` (number, 必填)
		 - `tagIds` (string，如 "1,2,3")
		 - `condition` (string, 必填)
		 - `images` (file[])：多张图片
	 - Controller：
		 1. 从上下文获取 `userID`；
		 2. 解析表单字段与图片文件；
		 3. 调用 `ProductService.CreateProduct`；
		 4. 成功返回商品详情；
		 5. 失败按错误码返回。

2. **编辑商品** `PUT /api/v1/products/:id`

	 - JSON 请求：
		 - 可选字段：`title?`, `description?`, `price?`, `categoryId?`, `tagIds?`, `condition?`, `imageUrls?`（重传逻辑可以简化为“覆盖式更新”）。
	 - Controller 执行参数校验后调用 `UpdateProduct`。

3. **状态变更** `POST /api/v1/products/:id/status`

	 - JSON 请求：`{ "action": "delist" | "relist" | "sold" }`
	 - Controller：
		 - 从 path 取 `id`，从鉴权取 `userID`；
		 - 调用 `ProductService.ChangeStatus`；
		 - 对于 `delist` 与 `relist`，在成功时写入撤销缓存（调用 Recommend 或 Redis 客户端）；TTL=3 秒；
		 - 返回新的商品状态。

4. **撤销状态变更** `POST /api/v1/products/:id/status/undo`

	 - 无请求体；
	 - Controller 调用 `ProductService.UndoLastStatusChange`；
	 - 若缓存不存在或冲突，返回 `3005`。

5. **商品详情** `GET /api/v1/products/:id`

	 - 可匿名访问；若请求头中带 token，则解析出 userID 传给 `GetProductDetail`；
	 - Controller 中不直接写 `user_recent_views` 表，由 Service 内调用推荐模块。

6. **我发布的商品** `GET /api/v1/products/my`

	 - Query 参数：
		 - `keyword`（可选）
		 - `page`, `pageSize`
	 - 返回：
		 - `items: [{id, title, price, status, createdAt, mainImageUrl}]`；
		 - `operations` 字段可选（如 `canEdit`, `canDelist`, `canRelist`），也可以由前端根据 status 推导。

7. **搜索** `GET /api/v1/products/search`

	 - Query：
		 - `q`（关键词，可空，为空时返回全部在售）
		 - `minPrice`、`maxPrice`（可选）
		 - `sort`：`latest` | `priceAsc` | `priceDesc`
		 - `page`, `pageSize`（默认 1, 20）
	 - Controller 将参数组装为 `SearchParams` 调用 Service；
	 - 返回分页商品卡片列表。

8. **分类浏览** `GET /api/v1/products/category/:categoryId`

	 - Query：`minPrice`, `maxPrice`, `sort`, `page`, `pageSize`；
	 - Controller 调用 `ListByCategory`。

### 6.2 前端页面设计

#### 6.2.1 发布商品页

路由：`/products/new`

- 从 `GET /api/v1/categories` 和 `GET /api/v1/tags` 获取分类与标签列表；
- 表单：标题、描述、价格、分类、标签多选、新旧程度、图片上传组件；
- 提交调用 `POST /api/v1/products`；
- 成功跳转到商品详情或“我发布的商品”。

#### 6.2.2 我发布的商品列表

路由：`/my/products`

- 调用 `GET /api/v1/products/my`；
- 列表卡片展示主图、标题、价格、状态；
- 操作按钮：
	- 在售：编辑、下架、标记已售；
	- 已下架：编辑、重新上架；
	- 已售：仅显示“已售出”标签；
- 下架/上架操作前弹确认对话框；确认后调用状态接口，再显示 3 秒撤销横幅。

#### 6.2.3 商品详情页

路由：`/products/:id`

- 调用 `GET /api/v1/products/:id`；
- 页面顶部根据 `status` 显示横幅：
	- `ForSale`：无横幅；
	- `Sold`：显示“此商品已售出”；
	- `Delisted`：显示“此商品已下架”；
- 卖家信息区展示头像和昵称，无跳转；
- 操作区：
	- 未登录：点击“联系卖家”时弹出登录框，登录完成后回到此页；
	- 登录且非发布者：点击“联系卖家”可弹出（课程项目可简化为显示卖家 QQ/微信号字段或引导线下沟通）；
	- 发布者本人：隐藏“联系卖家”。

#### 6.2.4 搜索结果页

路由：`/search?q=...`

- 顶部显示当前关键词；
- 提供价格区间输入与排序下拉框；
- 调用 `GET /api/v1/products/search`；
- 使用分页组件并显示总数。

---

## 7. 推荐模块详细设计（FP8、FP10、FP11）

### 7.1 数据模型与 Repository

`model/view_record.go`：

- 结构 `UserRecentView`：
	- `ID int64`
	- `UserID int64`
	- `ProductID int64`
	- `ViewedAt time.Time`

`repository/view_record_repo.go`：

- `AddView(ctx, userID, productID int64, viewedAt time.Time) error`；
- `ListRecentViews(ctx, userID int64, limit int) ([]UserRecentView, error)`；
- `TrimOldViews(ctx, userID int64, keep int) error`（或在 AddView 内实现）。

### 7.2 Service 设计

`service/recommend/service.go`：

- 结构 `RecommendationService`：依赖 `ViewRecordRepository`、`ProductRepository`、`TagRepository`、Redis。

方法：

1. `RecordView(ctx, userID, productID int64)`

	 - 步骤：
		 1. 插入视图记录 `AddView`；
		 2. 调用 `TrimOldViews` 保留最近 20 条；
		 3. 可忽略失败（不影响主流程），但记录日志。

2. `GetRecommendations(ctx, userID int64, maxCount int) ([]ProductCardDTO, error)`

	 - 缓存键：`recommend:user:{userID}`；TTL 可设为 5~10 分钟；
	 - 流程：
		 1. 尝试从缓存获取推荐商品 ID 列表；
		 2. 若缓存命中，则按 ID 查询产品详情并返回；
		 3. 若未命中：
				- 查询 `ListRecentViews` 获取最近 20 条记录；
				- 若为空则返回空数组，交由首页逻辑使用“最新发布在售”补齐；
				- 根据这些商品的 tag 统计频次，取 Top 3~5 标签；
				- 调用 `ProductRepository.Search` 或专门查询方法，在在售商品中筛选包含这些标签的商品，排除该用户自己发布的商品；
				- 截断到 `maxCount` 条；
				- 写入缓存；
				- 返回结果。

3. `GetHomeData(ctx, userID *int64, page, pageSize int) (*HomeDataDTO, error)`

	 - 入参：
		 - `userID`：可能为空（未登录）；
		 - `page` 用于“最新发布列表”的分页（推荐模块一般不分页，仅固定 5~10 条）。
	 - 逻辑：
		 1. 若 `userID` 非空：调用 `GetRecommendations(userID, 10)` 获取推荐商品列表；
		 2. 收集推荐商品 ID 列表 `recIDs`；
		 3. 调用 `ProductRepository.ListLatestForSale(excludeIDs=recIDs, page, pageSize)` 获取最新在售商品；
		 4. 若推荐结果不足 5 条，则在 Service 内用最新在售商品补齐推荐列表（保证推荐区 5~10 条）；
		 5. 返回 DTO：`{recommendations, latest}`。

### 7.3 Controller 与 API

`controller/recommend/controller.go` 或统一在 `controller/home` 中：

- `GET /api/v1/home`

	- 处理：
		1. 尝试从鉴权中间件获取 `userID`（可为空）；
		2. 读取查询参数 `page`, `pageSize`（默认 page=1, size=20）；
		3. 调用 `GetHomeData`；
		4. 返回：
			 ```json
			 {
				 "code": 0,
				 "data": {
					 "recommendations": [ ... ],
					 "latest": {
						 "items": [ ... ],
						 "page": 1,
						 "pageSize": 20,
						 "total": 100
					 }
				 }
			 }
			 ```

### 7.4 前端首页实现

路由：`/`

- 页面加载时调用 `GET /api/v1/home`；
- 若响应中 `recommendations` 非空且用户已登录，则在页面中部展示“猜你喜欢”区域；否则不显示此区域；
- “最新发布”列表使用分页组件，翻页时仅重新请求 latest，保持当前已展示的推荐列表不变；
- 前端需保证跨模块不重复：同一商品 ID 只在推荐或最新之一出现（后端已去重，前端不再二次处理即可）。

---

## 8. 分类与标签模块详细设计（FP14 + 后台部分）

### 8.1 CategoryService

`repository/category_repo.go`：

- `ListAll(ctx) ([]Category, error)`；
- `Create(ctx, c *Category) error`；
- `Update(ctx, c *Category) error`；
- `Delete(ctx, id int64) error`；
- `CountProducts(ctx, id int64) (int, error)`。

`service/category/service.go`：

- `ListCategories(ctx) ([]CategoryDTO, error)`；
- `CreateCategory(ctx, name, description string) error`；
- `UpdateCategory(ctx, id int64, name, description string) error`；
- `DeleteCategory(ctx, id int64) error`：
	- 步骤：
		1. 调用 `CountProducts`；
		2. 若 > 0，则返回错误码 `4001`；
		3. 否则调用 `Delete`。

Controller：

- `GET /api/v1/categories`（公开）；
- `POST /api/v1/admin/categories`（管理员）；
- `PUT /api/v1/admin/categories/:id`（管理员）；
- `DELETE /api/v1/admin/categories/:id`（管理员）。

分类浏览接口已在商品模块说明。

### 8.2 TagService

`repository/tag_repo.go`：

- `ListAll(ctx) ([]Tag, error)`；
- `Create(ctx, t *Tag) error`；
- `Update(ctx, t *Tag) error`；
- `Delete(ctx, id int64) error`；
- `CountProducts(ctx, id int64) (int, error)`。

`service/tag/service.go`：

- 逻辑同 CategoryService，删除前检查引用计数，引用 > 0 时返回 `4002`。

Controller：

- `GET /api/v1/tags`（公开）—— 发布商品页、编辑页使用；
- `POST /api/v1/admin/tags`；
- `PUT /api/v1/admin/tags/:id`；
- `DELETE /api/v1/admin/tags/:id`。

前端：

- 学生端在发布/编辑商品时调用 `GET /api/v1/tags`；
- 管理端提供分类/标签管理页面，使用 admin 前缀接口。

---

## 9. 后台管理模块详细设计

### 9.1 AdminService

`service/admin/service.go`：

- 依赖 `UserRepository`、`ProductRepository`、`CategoryRepository`、`TagRepository`。

方法：

1. `GetDashboardStats(ctx) (*DashboardDTO, error)`
	 - 内容：总用户数、总商品数、在售商品数、已售商品数等；
2. `ListUsers(ctx, keyword string, page, pageSize int) ([]UserAdminDTO, int, error)`；
3. `ListProducts(ctx, filters AdminProductFilter, page, pageSize int) ([]ProductAdminDTO, int, error)`。

### 9.2 Controller 与 API

`controller/admin/controller.go`：

- 所有接口需管理员权限；
- 路由示例：
	- `GET /api/v1/admin/dashboard`；
	- `GET /api/v1/admin/users`；
	- `GET /api/v1/admin/products`；
	- 分类/标签维护接口见上一节。

前端 admin-frontend：

- `views/dashboard`：展示统计数据；
- `views/user`：列表筛选用户；
- `views/product`：按状态查看商品；
- `views/category` / `views/tag`：管理分类和标签。

---

## 10. 关键业务流程伪代码

本节给出若干关键流程的伪代码，以便编码时参考实现顺序和边界处理。

### 10.1 商品上下架与撤销伪代码

**ChangeStatus（ProductService）**：

1. `p = repo.GetByID(productID)`，若为空 → 错误 `3001`；
2. 若 `p.SellerID != sellerID` → 错误 `3002`；
3. 若 `p.Status == "Sold"` → 错误 `3004`；
4. 根据 action 计算 `(from, to)`；
5. 若 `p.Status != from` → 错误 `3003`；
6. `repo.UpdateStatus(productID, from, to)`；
7. 若 action 为 `delist` 或 `relist`：
	 - 写入 Redis：`SETEX product:undo:productID:sellerID value="from->to" EX 3`；
8. 返回新状态。

**UndoLastStatusChange**：

1. 从 Redis 取键；若不存在 → `3005`；
2. 解析 `from`、`to`；
3. 查询当前产品 `p`；
4. 若 `p.SellerID != sellerID` → `3002`；
5. 若 `p.Status != to` → `3005`（冲突）；
6. 若 `to == "Sold"` → 不允许撤销，`3004`；
7. 调用 `repo.UpdateStatus(productID, to, from)`；
8. 删除 Redis 键；
9. 返回状态 from。

### 10.2 推荐计算伪代码

**GetRecommendations(userID)**：

1. `key = fmt.Sprintf("recommend:user:%d", userID)`；
2. 若 Redis 命中 → 解析 ID 列表并查询产品详情；
3. 否则：
	 1. `views = viewRepo.ListRecentViews(userID, 20)`；
	 2. 若为空 → 返回空列表；
	 3. 收集这些商品的 tagIDs，统计出现次数；
	 4. 取 TopN 标签；
	 5. 调用 `productRepo.SearchByTags(topTagIDs, excludeSeller=userID, status=ForSale, limit=10)`；
	 6. 将结果 ID 列表写入 Redis，设置短 TTL；
	 7. 返回结果。

---

## 11. 前后端接口一览表

为方便开发与对照，按模块列出主要 REST API（简略版）：

### 11.1 用户相关

| 接口 | 方法 | 说明 | 认证 |
|------|------|------|------|
| /api/v1/users/register | POST | 注册 | 否 |
| /api/v1/users/login | POST | 登录 | 否 |
| /api/v1/users/profile | GET | 获取个人信息 | 是 |
| /api/v1/users/profile | PUT | 修改昵称/头像 | 是 |
| /api/v1/users/password | PUT | 修改密码 | 是 |

### 11.2 商品相关

| 接口 | 方法 | 说明 | 认证 |
|------|------|------|------|
| /api/v1/products | POST | 发布商品 | 是 |
| /api/v1/products/{id} | PUT | 编辑商品 | 是（发布者） |
| /api/v1/products/{id}/status | POST | 上/下架/标记已售 | 是（发布者） |
| /api/v1/products/{id}/status/undo | POST | 撤销上/下架 | 是（发布者） |
| /api/v1/products/{id} | GET | 商品详情 | 否 |
| /api/v1/products/my | GET | 我发布的商品 | 是 |
| /api/v1/products/search | GET | 搜索商品 | 否 |
| /api/v1/products/category/{id} | GET | 分类浏览商品 | 否 |

### 11.3 首页与推荐

| 接口 | 方法 | 说明 | 认证 |
|------|------|------|------|
| /api/v1/home | GET | 首页数据（推荐 + 最新） | 可选 |

### 11.4 分类与标签

| 接口 | 方法 | 说明 | 认证 |
|------|------|------|------|
| /api/v1/categories | GET | 分类列表 | 否 |
| /api/v1/tags | GET | 标签列表 | 否 |
| /api/v1/admin/categories | POST | 新增分类 | 管理员 |
| /api/v1/admin/categories/{id} | PUT | 修改分类 | 管理员 |
| /api/v1/admin/categories/{id} | DELETE | 删除分类 | 管理员 |
| /api/v1/admin/tags | POST | 新增标签 | 管理员 |
| /api/v1/admin/tags/{id} | PUT | 修改标签 | 管理员 |
| /api/v1/admin/tags/{id} | DELETE | 删除标签 | 管理员 |

### 11.5 后台管理

| 接口 | 方法 | 说明 |
|------|------|------|
| /api/v1/admin/dashboard | GET | 仪表盘统计 |
| /api/v1/admin/users | GET | 用户列表 |
| /api/v1/admin/products | GET | 商品列表 |

---

## 12. 设计约束与实现建议

1. 避免 Controller 直接访问 Repository，所有业务逻辑放在 Service；
2. 所有写操作（注册、发布、编辑、状态变更等）必须进行事务控制，确保跨表一致性；
3. 密码必须使用安全哈希算法存储，不允许明文；
4. 所有对商品状态的修改必须通过 `ChangeStatus`/`UndoLastStatusChange`，不得绕过状态机；
5. 推荐逻辑只能使用最近 20 条浏览记录和标签匹配，不实现复杂算法；
6. 已售商品禁止任何形式的状态回退，相关接口收到请求一律返回错误；
7. 删除分类/标签前必须检查引用计数，禁止直接删除被引用的数据。

---

## 13. 结语

本详细设计文档对校园二手交易推荐系统的数据库结构、后端模块、接口协议、关键算法与前端页面交互做出了完整、可实现的定义。开发人员应在编码过程中严格遵循本文档的接口和约束；若实现过程中需要调整设计，需同步更新本详细设计，以保持与 `PRD.md` 和《概要设计》的一致性。
